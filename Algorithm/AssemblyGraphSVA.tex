\documentclass[10pt]{article}
\usepackage{hyperref}

% amsmath package, useful for mathematical formulas
\usepackage{amsmath}
% amssymb package, useful for mathematical symbols
\usepackage{amssymb}

% graphicx package, useful for including eps and pdf graphics
% include graphics with the command \includegraphics
\usepackage{graphicx}

% cite package, to clean up citations in the main text. Do not remove.
%\usepackage{cite}

\usepackage{color} 

\usepackage{bm}

% Use doublespacing - comment out for single spacing
\usepackage{setspace} 
%\doublespacing

% Use the natbib bibtex style
\usepackage[round]{natbib}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother

\date{}

\pagestyle{myheadings}

\newcommand\titlestring{Structured Variational Approximation for Gaussian Assembly Graphs}


\newcommand\shorttitlestring{Assembly SVA}

\markboth{\shorttitlestring}{\shorttitlestring}

\newcommand\authorstring{Christopher Quince}

\usepackage{array}

% Labels & references for sections, figures and tables
% Comment out \secref and \seclabel for PLoS -- they don't have numbered section references.
\newcommand{\secref}[1]{Section~\ref{sec:#1}}
\newcommand{\seclabel}[1]{\label{sec:#1}}
\newcommand{\secname}[1]{``#1''}  % PLoS-style section names

% "Text S1", "Text S2", etc.
\newcommand{\supptext}[1]{Text S#1}

% "Dataset S1", "Dataset S2", etc.
\newcommand{\dataset}[1]{Dataset S#1}

% Appendix
\newcommand{\appref}[1]{Appendix~\ref{app:#1}}
\newcommand{\applabel}[1]{\label{app:#1}}

% Figure
\newcommand{\figref}[1]{Figure~\ref{fig:#1}}
\newcommand{\figlabel}[1]{\label{fig:#1}}

% Table
\newcommand{\tabnum}[1]{\ref{tab:#1}}
\newcommand{\tabref}[1]{Table~\tabnum{#1}}
\newcommand{\tablabel}[1]{\label{tab:#1}}

% Equation
\newcommand{\eqnref}[1]{Equation~\ref{eqn:#1}}
\newcommand{\eqnlabel}[1]{\label{eqn:#1}}


% need cite, check me, and other notes to self
\newcommand\needcite{{\bf [CITE]}}
\newcommand\checkme{{\bf [CHECK]}}

% For collaborative notes, define a "red pen"
\newcommand\redpen[1]{{\bf \textcolor{red}{#1}} \textcolor{black}{}}


% argmax
\newcommand\argmax{\mbox{argmax}}



%% END MACROS SECTION

\begin{document}

% Title should be 10 words or less
\begin{flushleft}
  {\Large
    \textbf{\titlestring}
  }
\\
\authorstring
\end{flushleft}

\section{The model}

We consider an assembly graph comprised of unitig sequennce nodes $v = 1,\ldots,V$  and directed edges 
${u,v}$ defining overlaps. We define: 
\begin{itemize}

\item Counts $x_{v,s}$ for each unitig $v = 1,\ldots,V$ in sample $s = 1,\ldots,S$

\item Paths for strain $g = 1,\ldots,G$ defined by $\eta^g_{u,v} \in {0,1}$

\item Flow of strain $g$ through $v$, $\phi^{g+}_v = \sum_{u \in A(v)} \eta^g_{u,v}$ 
and $\phi^{g-}_v = \sum_{u \in D(v)} \eta^g_{v,u}$ where $A(v)$ is set of ancestors of $v$ 
and $D(v)$ descendants in the assembly graph

\item The following is true  $\phi^{g+}_v =  \phi^{g-}_v = \phi^{g}_v$

\item Strain coverages $\gamma_{g,s}$

\item Unitig lengths $L_v$

\item Unitig bias $\theta_v$

\item Source node $s$ and sink node $t$

\end{itemize}

\noindent Then assume normally distributed counts for each node in each sample giving a joint density for observations and latent variables: 
\begin{multline}
P(\mathbf{X},\mathbf{\Gamma},\mathbf{H},\mathbf{\Theta})  = \prod_{v=1}^V \prod_{s=1}^S \mathcal{N}(x_{v,s}|L_v \theta_v [\sum_{h=1}^G \phi^h_v \gamma_{h,s}],\tau^{-1}) 
\prod_{h=1}^G \prod_{s=1}^S P(\gamma_{h,s} | \lambda_h) \\
.\prod_{h=1}^G \prod_{v=1}^V \left[ \phi^{h+}_v = \phi^{h-}_v \right]
 \left[ \phi^{h-}_s = 1\right]  \left[\phi^{h+}_t = 1\right] P(\tau) \\ .\prod_{h=1}^G P(\lambda_h | \alpha_0, \beta_0) 
 \prod_{v=1}^V P(\theta_v | \mu_0, \tau_0)
\end{multline}
where $\left[\right]$ indicates the Iverson bracket evaluating to 1 if the condition is true and zero otherwise. We assume an exponential prior for the $\gamma_{g,s}$ with a rate parameter that is strain dependent, 
such that:
\begin{equation}
P(\gamma_{g,s}| \lambda_g) = \lambda_g \exp(-\gamma_{g,s} \lambda_g)
\end{equation}
We then place gamma hyper-priors on the $\lambda_g$:
\begin{equation}
P(\lambda_{g}| \alpha_0, \beta_0) =  \frac{\beta_0^\alpha}{\Gamma (\alpha_0)} \lambda_g^{\alpha_0 - 1} \exp(- \beta_0 \lambda_g)
\end{equation}

\noindent and a Gamma prior for the precision:
\begin{equation}
P(\tau | \alpha, \beta) = \frac{\beta^\alpha}{\Gamma(\alpha)} \tau^{\alpha - 1} \exp(-\beta \tau)
\end{equation}

\noindent for the biases $\theta_v$ we use a truncated normal prior:

\begin{align*}
P(\theta_v | \mu_0, \tau_0) & = & \frac{\sqrt{\frac{\tau_0}{2 \pi}}  \exp(- \frac{\tau_0}{2} (\theta_v - \mu_0)^2)  }{1 - \Psi(-\mu_0 \sqrt \tau_0 )}  \;\;\; \theta_v >= 0 \\
                            & = & 0 \;\;\; \theta_v < 0 \\
\end{align*}
where $\Psi$ is the standard normal cumulative distribution. 
%

\section{Variational Approximation}

We use variational inference to obtain an approximate solution to the posterior distribution of this model \cite{blei17}. In 
particular because all the distributions are conjugate we can employ CAVI, coordinate ascent variational inference. Our starting 
point is to assume the following factorisation for the variational approximation:
\begin{equation}
q(\mathbf{X},\mathbf{\Gamma},\mathbf{H})  =  \prod_{h=1}^G q_h(\{ \eta^h_{v,u} \} _{u,v \in A}) \prod_{h=1}^G \prod_{s=1}^S q_h(\gamma_{h,s})  \prod_{h=1}^G q_h(\lambda_{h}) \prod_{v=1}^V q_v(\theta_v) q(\tau)
\end{equation}
where $A$ are all pairs of nodes in assembly graph. Note that we assumed a fully factorised approximation except for the $\eta^h_{v,u}$, the paths for each strain through the graph.  There 
we assume that the path for each strain forms a separate factor allowing strong correlations between the different elements of the path.

\noindent Then the mean field update for each set of $ \{\eta^h_{v,u}\}_{u,v \in A}$ is derived as:
\begin{align*}
\ln q_h^*( \{ \eta^h_{v,u} \} _{u,v \in A}) & =  \left\langle \ln P \right\rangle _{ \phi^{h \neq g}_{v \in A},\gamma_{g,s}, \theta_v, \lambda_g}  \\
& =  \ln \left( \prod_{v=1}^V \delta_{ \phi^{g+}_v, \phi^{g-}_v} \delta_{\phi^{g-}_s,1}  \delta_{\phi^{g+}_t,1} \right) \\
& - \left\langle \sum_{v=1}^V \sum_{s=1}^S \frac{\tau}{2} \left( x_{v,s} - \theta_v L_v[\sum_{h=1}^G \phi^h_v \gamma_{h,s}] \right)^2 \right\rangle _{ \phi^{h \neq g}_{v \in A},\gamma_{g,s}}
\end{align*}

\noindent Consider the second term only:
\begin{equation*}
 - \frac{\langle \tau \rangle}{2}  \left ( 
- \sum_{v=1}^V \sum_{s=1}^S 2 x_{v,s} L_v \langle \theta_v \rangle \langle \gamma_{g,s} \rangle \phi^{g}_v
+ L_v^2 \langle {\theta_v}^2 \rangle \langle (\sum_{h=1}^G \phi^h_v \gamma_{h,s}) (\sum_{g=1}^G \phi^g_v \gamma_{g,s}) \rangle)
\right )
\end{equation*}

\begin{equation*}
 - \frac{\langle \tau \rangle}{2} \left ( 
 \sum_{v=1}^V \sum_{s=1}^S \left [ -2 x_{v,s} \langle \theta_v \rangle L_v \langle \gamma_{g,s} \rangle \phi^{g}_v
+ 2 L_v^ 2 \langle {\theta_v}^2 \rangle \sum_{h \neq g }^G \langle \phi^h_v \rangle \langle \gamma_{h,s} \rangle \langle \gamma_{g,s} \rangle \phi^{g}_v
+ L_v^2  \langle {\theta_v}^2 \rangle \langle \gamma_{g,s}^2 \rangle (\phi^{g}_v)^2
\right]
\right )
\end{equation*}
This gives a posterior distribution for the  $q_h(\{ \eta^h_{v,u} \}$ that is discrete. 
We solve this together with the constraints  


\noindent Next we consider the mean field update for the $\gamma_{g,s}$
\begin{align*}
\ln q^*(\gamma_{g,s}) & =  \left\langle \ln P \right\rangle_{ \phi^{h}_{v \in A},\gamma_{h \neq g,t \neq s}} \\
& =  - \left\langle \sum_{v=1}^V \frac{\tau}{2}\left( x_{v,s} - \theta_v L_v[\sum_{h=1}^G \phi^h_v \gamma_{h,s}] \right)^2 \right\rangle _{\phi^{h}_{v \in A},\gamma_{h \neq g,t \neq s}} - \frac{\gamma_{g,s}}{\epsilon}
\end{align*}

\begin{align*}
\ln q^*(\gamma_{g,s}) & = 
& =  - \frac{\langle \tau \rangle }{2} \left ( \sum_{v=1}^V -2 x_{v,s} \langle \theta_v \rangle L_v \langle \phi^g_{v} \rangle \gamma_{g,s}  
+ 2 \langle \theta_v^2 \rangle L_v^2 \gamma_{g,s} \langle \phi_v^g \rangle \sum_{h \neq g } \langle \gamma_{h,s} \rangle \langle \phi^h_{v} \rangle
+ \langle \theta_v^2 \rangle L_v^2 \gamma_{g,s}^2 \langle [\phi^g_{v}]^2  \rangle
\right)
- \frac{\gamma_{g,s}}{\epsilon}
\end{align*}
with the restriction $\gamma_{g,s} > 0$ this gives a truncated Normal distribution for $\gamma_{g,s}$.
With mean:
\begin{align}
\mu_{g,s}  & = \frac{\sum_v x_{v,s} \theta_v L_v \langle \phi_v^g \rangle  - \langle \phi_v^g \rangle \sum_{h \neq g} \langle \gamma_{h,s} \rangle \langle \phi^h_v\rangle \langle \theta_v^2 \rangle L_v^2}{\sum_{v} L_v^2  \langle [\phi^g_{v}]^2  \rangle} - \frac{1}{\epsilon \tau_{g,s} }\\
\tau_{g,s} & = \langle \tau \rangle \sum_{v} L_v^2  \langle [\phi^g_{v}]^2  \rangle  \\
\end{align}

% if your bibliography is in bibtex format, use those commands:
\bibliographystyle{bmc-mathphys} % Style BST file (bmc-mathphys, vancouver, spbasic).
%% BioMed_Central_Bib_Style_v1.01

\bibliography{StrainResolution}      % Bibliography file (usually '*.bib' )


\end{document}


